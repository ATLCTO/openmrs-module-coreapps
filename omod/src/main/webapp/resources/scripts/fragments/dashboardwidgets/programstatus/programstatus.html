<!-- TODO: **localize all** -->
<!-- TODO: move css? -->
<style>
    .no-padding {
        padding:0px;
    }

    .inline-block {
        display: inline-block;
    }

    li div {
        display: inline-block;
    }
</style>


<ul style="font-size: 0.8em" ng-if="!ctrl.patientProgram">
    <li>
        Enrollment Date:
        <input type="text" uib-datepicker-popup="{{ctrl.dateFormat}}" datepicker-options="ctrl.datePopup.enrollment.options" ng-model="ctrl.input.dateEnrolled"
               is-open="ctrl.datePopup.enrollment.opened" close-text="Close" />
        <i class="icon-calendar" ng-click="ctrl.toggleDatePopup.enrollment()"/>
    </li>
    <li>
        Enrollment Location:
        <select ng-model="ctrl.input.enrollmentLocation"
                ng-options="location.uuid as location.display for location in ctrl.programLocations">
                <option value=""></option>
        </select>
        <button ng-click="ctrl.enroll()">Enroll</button>
    </li>
</ul>

<ul style="font-size: 0.8em" ng-if="ctrl.patientProgram">
    <li>
        <i ng-if="!ctrl.edit.enrollment" ng-click="ctrl.toggleEdit.enrollment()" class="icon-pencil right no-padding"/>
        Enrolled since {{ ctrl.patientProgram.dateEnrolled | date:ctrl.dateFormat }} <span ng-if="ctrl.patientProgram.location">at {{ ctrl.patientProgram.location.display }}</span>
    </li>

    <li ng-if="ctrl.edit.enrollment">
        <icon class="icon-remove right"  ng-click="ctrl.toggleEdit.enrollment()" />
        <icon class="icon-check right" ng-click="ctrl.updatePatientProgram()"/>
        <input class="inline-block" type="text" uib-datepicker-popup="{{ctrl.dateFormat}}" datepicker-options="ctrl.datePopup.enrollment.options" ng-model="ctrl.input.dateEnrolled"
           is-open="ctrl.datePopup.enrollment.opened" popup-placement="top-left" close-text="Close"/>
        <i class="icon-calendar inline-block" ng-click="ctrl.toggleDatePopup.enrollment()"/>
    </li>

    <li ng-if="ctrl.edit.enrollment">
        <icon class="icon-remove right"  ng-click="ctrl.toggleEdit.enrollment()" />
        <icon class="icon-check right" ng-click="ctrl.updatePatientProgram()"/>
        <select ng-model="ctrl.input.enrollmentLocation"
                ng-options="location.uuid as location.display for location in ctrl.programLocations">
            <option value=""></option>
        </select>
    </li>

    <span ng-repeat="workflow in ctrl.program.allWorkflows track by $index">
        <li ng-if="ctrl.program.allWorkflows.length != 0">
            <i ng-if="!ctrl.edit.workflow[workflow.uuid]" ng-click="ctrl.toggleEdit.workflow(workflow.uuid)" class="icon-pencil right no-padding"/>
            <b>{{ workflow.concept.display }}</b>: {{ ctrl.getMostRecentStateForWorkflow(workflow.uuid).state.concept.display }}
        </li>

        <li ng-if="ctrl.edit.workflow[workflow.uuid]">
            <icon class="icon-remove right"  ng-click="ctrl.toggleEdit.workflow(workflow.uuid)" />
            <icon class="icon-check right" ng-click="ctrl.updatePatientState(workflow.uuid)"/>
            Transition to:
            <select ng-model="ctrl.input.changeToStateByWorkflow[workflow.uuid].state"
                    ng-options="state.uuid as state.concept.display for state in ctrl.statesByWorkflow[workflow.uuid] | filter: ctrl.isNotCurrentState(workflow) ">
                 <option value=""></option>
            </select>
        </li>

        <li ng-if="ctrl.edit.workflow[workflow.uuid]">
            on: <input type="text" uib-datepicker-popup="{{ctrl.dateFormat}}" datepicker-options="ctrl.datePopup.workflow[workflow.uuid].options" ng-model="ctrl.input.changeToStateByWorkflow[workflow.uuid].date"
                   is-open="ctrl.datePopup.workflow[workflow.uuid].opened" close-text="Close" />
            <i class="icon-calendar" ng-click="ctrl.toggleDatePopup.workflow(workflow.uuid)"/>
        </li>
    </span>
</ul>

<div ng-if="ctrl.hasHistory()">
    <span style="font-size: 0.8em">
        History
        <i ng-click="ctrl.toggleHistory()" ng-if="!ctrl.history.expanded" class="icon-plus"/>
        <i ng-click="ctrl.toggleHistory()" ng-if="ctrl.history.expanded" class="icon-minus"/>
    </span>

    <table ng-if="ctrl.history.expanded" style="font-size: 0.6em">  <!-- TODO pull out into style sheet -->
        <tr>
            <th>Date</th>
            <th ng-repeat="workflow in ctrl.program.allWorkflows">
                {{ workflow.concept.display }}
            </th>
            <th>&nbsp;</th>
        </tr>
        <tr ng-repeat="row in ctrl.patientStateHistory">
            <td>{{ row.startDate | date:ctrl.dateFormat }} </td>
                <td ng-repeat="workflow in ctrl.program.allWorkflows">
                    {{ row.patientStatesByWorkflow[workflow.uuid].state.concept.display }}
                </td>
            <td>
                <i ng-if="$first" class="icon-remove right" ng-click="ctrl.deleteMostRecentPatientStates()"/>
            </td>
        </tr>
    </table>
</div>